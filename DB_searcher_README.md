## DATABASE searcher

This document describes the database searching pipeline used in the MA dbexplorer application.
Authored by Christopher Fitzgerald. github https://github.com/ChemCharles 

**Table of Contents**

* Introduction
* How to use
* Database Cleaning Pipeline
* Database Searching Pipeline
* Custom Databases
* Note on Database Structure

## Introduction

The pipeline consists of two main parts:

1. **Db cleaning pipeline:** This uses the CompoundDB package to extract a normalized database from SDF files. The output is cleaned by removing NA and zero values, followed by calculating and appending adducts to the database.
2. **Db searching pipeline:** This filters the database based on user-specified adducts and elements of interest. It then searches the database for matches with the user's m/z values within a user-defined ppm range.

The pipeline is designed to be flexible and allow users to incorporate their own custom databases from SDF files or from their own databases, so long as it follows the same format as described in the db cleaning pipeline step.

## How to use:
1. Use the Clean_db_QIMR.R script to process and format SDF files to cleaned db. Also, it will calculate and append adducts. 
2. Use the DB_searcher_piepline_QIMR.R script to search mz list (generated by MSI experiments) against the database that you generated in the Clean_db_QIMR.R pipeline.

## Database Cleaning Pipeline:

The cleaning pipeline starts by extracting the database from SDF files using CompoundDB. It then performs the following tasks:

1. Removes NA and zero values from the database.
2. Calculates adducts for each molecule and appends them to the database.

The resulting output is a clean and normalized database suitable for searching.

## Database Searching Pipeline:

The searching pipeline uses the cleaned database to search for matches based on the following user-specified parameters:

* **Adducts:** The types of adducts to be considered. Up to 47 common adducts can be calculated over positive and negative mode.
* **Elements:** The elements to be considered. Filters out elements that are deemed not natural, or only allows elements set by the user. i.e., natural elements are "H", "C", "N", "O", "S", "Cl", "Br", "F", "Na", "P", "I".
* **ppm range:** The tolerance for matching m/z values. This gives better matching than just doing a blanket absolute mass error (Da). As ms will work in ppm.   

The pipeline performs the following steps:

1. **Filter the database:** Only molecules containing the specified adducts and elements are considered.
2. **Calculate m/z values:** The m/z values for all possible adducts are calculated for each molecule.
3. **Match m/z values:** The calculated m/z values are compared to the user's m/z values within the specified ppm range.

The pipeline returns a list of matches, along with their corresponding information such as formula, exact mass, and adducts.

## Custom Databases:

The pipeline is designed to be flexible and allow users to incorporate their own custom databases. To do this, users should provide their database in SDF format. The pipeline will automatically handle the cleaning and normalization process.

An additional script called DBsearcher_pipeline_custom.R has also been included. This takes in a custom db (See structure in inst/custom_db_search/Query_Custom.csv) and matches it to a list. It will match and return m/z and retention time values and the error of the matches. The ranges of both of these are set by the user. 
Note this does not consider adducts, the input database values are also in m/z and not neutral mass as is the case in the pipeline. 

The reason for adding this additional script is that it can be adapted to use other orthogonal ms or separation techniques. For instance instead of RT matching you could use CCS values from ion mobility. 

## Note on Database Structure:

The database structure used in this pipeline summarizes isomers in terms of matching formulas and exact masses. This means that a single m/z value may match multiple isomers (1-many relationship). However, all possible isomers are reported as a single match, simplifying the interpretation of the results.

This level of matching corresponds to a level 4 match according to the International Metabolomics Standards Initiative (MSI) definition.



